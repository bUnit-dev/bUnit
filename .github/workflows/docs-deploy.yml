name: "docs-deploy"

on:
  push:
    branches:
      - stable
    paths-ignore:
      - '!docs/**'

  workflow_dispatch:

jobs:
  deploy:
    name: ğŸ“ƒ Deploy new version bunit.dev
    runs-on: windows-latest
    steps:

      - name: ğŸ›’ Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          token: ${{ secrets.BUNIT_BOT_TOKEN }}

      - name: âš™ï¸ Import GPG key
        id: import_gpg
        uses: crazy-max/ghaction-import-gpg@v3
        with:
          gpg-private-key: ${{ secrets.BUNIT_BOT_GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.BUNIT_BOT_GPG_KEY_PASSPHRASE }}

      - name: âš™ï¸ Setup CI GIT
        run: |
          git config user.name "${{ steps.import_gpg.outputs.name }}"
          git config user.email ${{ steps.import_gpg.outputs.email }}
          git config --global user.signingkey ${{ steps.import_gpg.outputs.keyid }}
          git config --global commit.gpgsign true

      - name: âš™ï¸ Setup GIT versioning
        uses: dotnet/nbgv@v0.4.0
        with:
          setAllVars: true

      - name: ğŸ› ï¸ Get Changelog Entry
        id: changelog_reader
        uses: mindsers/changelog-reader-action@v2
        with:
          path: ./CHANGELOG.md

      - name: ğŸ› ï¸ Update tokens in project files
        uses: cschleiden/replace-tokens@v1
        env:
          RELEASE-VERSION: ${{ steps.changelog_reader.outputs.version }}
        with:
          files: '["docs/site/*.md", "docs/**/*.md", "docs/**/*.tmpl.partial", "*.csproj", "**/*.csproj"]'

      - name: âš™ï¸ Setup dotnet 3.1.x
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: '3.1.x'

      - name: âš™ï¸ Setup dotnet 5.0.x
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: '5.0.x'

      - name: ğŸ› ï¸ Building bUnit
        run: dotnet build /p:PublicRelease=true

      - name: ğŸ› ï¸ Verfiy docs samples
        run: dotnet test docs/samples/samples.sln

      - name: ğŸ› ï¸ Building docs
        run: |
          dotnet build docs/site/
          dotnet build docs/site/

      - name: ğŸ› ï¸ Deploy to GitHub Pages
        if: success()
        uses: crazy-max/ghaction-github-pages@v2
        with:
          build_dir: docs/site/_site
          fqdn: bunit.dev
          repo: bUnit-dev/bUnit-dev.github.io
          target_branch: main
          keep_history: false
          jekyll: false
          committer: "bUnit bot <bot@bunit.dev>"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_PAT: ${{ secrets.BUNIT_BOT_TOKEN }}

      - name: â© Merge stable with main, push origin
        run: |
          git checkout main
          git merge -S stable
          git push origin main

      - name: â­ Create pull request from stable to main when direct merge fails
        if: ${{ failure() }}
        uses: thomaseizinger/create-pull-request@1.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.BUNIT_BOT_TOKEN }}
        with:
          head: stable
          base: main
          title: Update main with documentation in stable
          reviewers: ${{ github.actor }} # By default, we request a review from the person who triggered the workflow.
          body: |
            Hi @${{ github.actor }}

            This PR was created because the [docs-deploy](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) failed to automatically merge stable into main.
